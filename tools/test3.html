<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DR.PDF PRO v26</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { margin: 0; background: #0f172a; color: white; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .nav-top { background: #1e293b; padding: 8px; display: flex; gap: 5px; border-bottom: 2px solid #6366f1; flex-wrap: wrap; justify-content: center; z-index: 100; }
        
        .editor-area { flex: 1; overflow: auto; display: flex; justify-content: center; align-items: flex-start; background: #334155; padding: 10px; touch-action: pinch-zoom; }
        
        .btn { cursor: pointer; padding: 6px 8px; font-weight: bold; border-radius: 4px; border: none; background: #475569; color: white; font-size: 11px; }
        .btn.active { background: #6366f1; }
        
        .setting-box { display: flex; align-items: center; gap: 4px; background: #0f172a; padding: 4px 8px; border-radius: 6px; flex-wrap: wrap; }
        select, input { background: #1e293b; color: white; border: 1px solid #6366f1; font-size: 11px; border-radius: 3px; }

        .controls { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); background: #1e293b; padding: 8px 15px; border-radius: 30px; display: flex; gap: 10px; border: 1px solid #6366f1; z-index: 1000; }
        #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    </style>
</head>
<body>

<div class="nav-top">
    <input type="file" id="fileInput" accept="application/pdf" style="width: 120px;">
    <button id="btn-text" class="btn active" onclick="setMode('text')">TEXT</button>
    <button id="btn-white" class="btn" onclick="setMode('white')">üñçÔ∏èWHITE</button>
    <button id="btn-brush" class="btn" onclick="setMode('brush')">üñåÔ∏èPEN</button>
    <button id="btn-eraser" class="btn" onclick="setMode('eraser')">üßΩERASER</button>
    
    <div class="setting-box">
        <select id="fontFamily" onchange="updateStyle()">
            <option value="Arial">Arial</option>
            <option value="Courier New">Courier</option>
            <option value="Georgia">Georgia</option>
        </select>
        <button class="btn" onclick="toggleBold()"><b>B</b></button>
        <input type="number" id="globalSize" value="20" style="width:35px;" oninput="updateStyle()">
        <input type="color" id="globalColor" value="#ff0000" oninput="updateStyle()">
    </div>
    <button onclick="savePDF()" style="background:#10b981;" class="btn">SAVE</button>
</div>

<div class="editor-area">
    <canvas id="c"></canvas>
</div>

<div class="controls">
    <button class="btn" onclick="changePage(-1)">‚óÄ</button>
    <span id="pgInfo">0 / 0</span>
    <button class="btn" onclick="changePage(1)">‚ñ∂</button>
</div>

<div id="loading"><h3>PROCESSING...</h3></div>

<script>
    const pdfjs = window['pdfjs-dist/build/pdf'];
    pdfjs.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let canvas = new fabric.Canvas('c', { selection: true, allowTouchScrolling: true });
    let pdfDoc = null, curPage = 1, mode = 'text';
    let isDrawing = false, startX, startY, activeRect;

    // 1. Load PDF
    document.getElementById('fileInput').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        toggleL(true);
        const reader = new FileReader();
        reader.onload = async function() {
            pdfDoc = await pdfjs.getDocument(new Uint8Array(this.result)).promise;
            renderPage(1);
        };
        reader.readAsArrayBuffer(file);
    };

    // 2. Render Page (Anti-Crop Logic)
    async function renderPage(num) {
        toggleL(true);
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale: 1.5 });
        
        const tempC = document.createElement('canvas');
        const ctx = tempC.getContext('2d');
        tempC.height = viewport.height; tempC.width = viewport.width;
        await page.render({ canvasContext: ctx, viewport }).promise;
        
        canvas.setDimensions({ width: viewport.width, height: viewport.height });
        fabric.Image.fromURL(tempC.toDataURL('image/jpeg', 0.8), (img) => {
            canvas.clear();
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
            // Zoom to fit screen width on mobile
            if(window.innerWidth < 600) {
                const ratio = (window.innerWidth - 20) / viewport.width;
                canvas.setZoom(ratio);
                canvas.setDimensions({ width: viewport.width * ratio, height: viewport.height * ratio });
            }
            document.getElementById('pgInfo').innerText = num + " / " + pdfDoc.numPages;
            toggleL(false);
        });
        curPage = num;
    }

    // 3. Toolbar Logic
    function setMode(m) {
        mode = m;
        canvas.isDrawingMode = (m === 'brush');
        canvas.allowTouchScrolling = (m === 'text');
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+m).classList.add('active');
        if(m === 'brush') {
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            canvas.freeDrawingBrush.width = parseInt(document.getElementById('globalSize').value);
            canvas.freeDrawingBrush.color = document.getElementById('globalColor').value;
        }
    }

    function updateStyle() {
        const obj = canvas.getActiveObject();
        const size = parseInt(document.getElementById('globalSize').value);
        const color = document.getElementById('globalColor').value;
        const font = document.getElementById('fontFamily').value;

        if (obj && obj.type === 'i-text') {
            obj.set({ fontSize: size, fill: color, fontFamily: font });
            canvas.renderAll();
        }
    }

    function toggleBold() {
        const obj = canvas.getActiveObject();
        if (obj && obj.type === 'i-text') {
            obj.set('fontWeight', obj.fontWeight === 'bold' ? 'normal' : 'bold');
            canvas.renderAll();
        }
    }

    // 4. Whitener & Eraser
    canvas.on('mouse:down', function(o) {
        const p = canvas.getPointer(o.e);
        if(mode === 'eraser' && o.target) {
            canvas.remove(o.target);
        }
        if(mode === 'white') {
            isDrawing = true;
            startX = p.x; startY = p.y;
            activeRect = new fabric.Rect({
                left: startX, top: startY, width: 0, height: 0, fill: 'white', strokeWidth: 0
            });
            canvas.add(activeRect);
        }
    });

    canvas.on('mouse:move', function(o) {
        if (!isDrawing || mode !== 'white') return;
        const p = canvas.getPointer(o.e);
        activeRect.set({ 
            width: Math.abs(startX - p.x), height: Math.abs(startY - p.y),
            left: Math.min(p.x, startX), top: Math.min(p.y, startY)
        });
        canvas.renderAll();
    });

    canvas.on('mouse:up', () => isDrawing = false);

    canvas.on('mouse:dblclick', (o) => {
        if(mode !== 'text') return;
        const p = canvas.getPointer(o.e);
        const text = new fabric.IText('Tap to Type', {
            left: p.x, top: p.y,
            fontSize: parseInt(document.getElementById('globalSize').value),
            fill: document.getElementById('globalColor').value,
            fontFamily: document.getElementById('fontFamily').value
        });
        canvas.add(text);
        text.enterEditing();
    });

    function changePage(d) {
        if(pdfDoc && curPage+d >= 1 && curPage+d <= pdfDoc.numPages) renderPage(curPage+d);
    }

    function toggleL(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }

    async function savePDF() {
        toggleL(true);
        const { jsPDF } = window.jspdf;
        // Reset zoom for clean export
        const currentZoom = canvas.getZoom();
        canvas.setZoom(1);
        
        const pdf = new jsPDF({ 
            orientation: canvas.width > canvas.height ? 'l' : 'p',
            unit: 'px', format: [canvas.width / currentZoom, canvas.height / currentZoom] 
        });
        
        canvas.discardActiveObject().renderAll();
        pdf.addImage(canvas.toDataURL({format: 'jpeg', quality: 0.5}), 'JPEG', 0, 0, canvas.width / currentZoom, canvas.height / currentZoom);
        pdf.save("DrPDF_Final.pdf");
        
        canvas.setZoom(currentZoom);
        toggleL(false);
    }
</script>
</body>
</html>